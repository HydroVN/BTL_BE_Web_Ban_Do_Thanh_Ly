@model WebBH.Models.Order

@{
    ViewData["Title"] = "Chi tiết đơn hàng #" + Model.OrderId;
    Layout = "~/Views/Shared/_Layout.cshtml";

    // 1. LOGIC TÍNH TOÁN THANH TIẾN TRÌNH
    int step = 0;
    string s = Model.Status ?? "";
    if (s == "Pending") { step = 1; }
    else if (s == "Packing") { step = 2; }
    else if (s == "Shipping") { step = 3; }
    else if (s == "Success" || s == "Completed") { step = 4; }

    // Độ dài thanh màu xanh
    string progressWidth = "0%";
    if (step == 2) progressWidth = "33%";
    if (step == 3) progressWidth = "66%";
    if (step >= 4) progressWidth = "100%";

    // 2. LOGIC FILL DỮ LIỆU
    var receiverName = !string.IsNullOrEmpty(Model.ReceiverName) ? Model.ReceiverName : (Model.User?.FullName ?? "Khách hàng");
    var receiverPhone = !string.IsNullOrEmpty(Model.ReceiverPhone) ? Model.ReceiverPhone : (Model.User?.PhoneNumber ?? "---");
    var shippingAddress = !string.IsNullOrEmpty(Model.ShippingAddress) ? Model.ShippingAddress : "Địa chỉ chưa cập nhật";
}

<link rel="stylesheet" href="~/css/order-details-custom.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/review-modal.css" asp-append-version="true" />

<div class="order-detail-page">
    <div class="page-header-box">
        <div class="container d-flex justify-content-between align-items-center">
            <h4 class="fw-bold m-0">
                <i class="bi bi-box-seam me-2"></i>Chi tiết đơn hàng #@Model.OrderId
            </h4>
            <a asp-action="Index" class="btn btn-outline-dark btn-sm">
                <i class="bi bi-arrow-left me-1"></i> Quay lại
            </a>
        </div>
    </div>

    <div class="container">

        @if (TempData["Message"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i> @TempData["Message"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <div class="stepper-wrapper">
            <div class="stepper-progress-line" style="width: @progressWidth;"></div>

            <div class="stepper-item @(step >= 1 ? "active" : "")">
                <div class="step-counter"><i class="bi bi-clipboard-check"></i></div>
                <div class="step-name">Chờ xác nhận</div>
                <div class="step-date">@Model.OrderDate?.ToString("HH:mm dd/MM")</div>
            </div>

            <div class="stepper-item @(step >= 2 ? "active" : "")">
                <div class="step-counter"><i class="bi bi-box-seam"></i></div>
                <div class="step-name">Đang đóng gói</div>
                <div class="step-date">@(step >= 2 ? "Đã xử lý" : "")</div>
            </div>

            <div class="stepper-item @(step >= 3 ? "active" : "")">
                <div class="step-counter"><i class="bi bi-truck"></i></div>
                <div class="step-name">Đang vận chuyển</div>
                <div class="step-date">@(step >= 3 ? "Đang giao" : "")</div>
            </div>

            <div class="stepper-item @(step >= 4 ? "active" : "")">
                <div class="step-counter"><i class="bi bi-check-lg"></i></div>
                <div class="step-name">Thành công</div>
                <div class="step-date">@(step >= 4 ? "Hoàn tất" : "")</div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8 mb-4">
                <h5 class="section-title">Sản phẩm đã đặt</h5>
                <div class="product-card-list">
                    @foreach (var item in Model.OrderDetails)
                    {
                        <div class="product-item-row">
                            <div class="prod-img-box">
                                <img src="@(string.IsNullOrEmpty(item.Product?.ImageUrl) ? "https://dummyimage.com/100x100/eee/aaa" : item.Product.ImageUrl)"
                                     class="prod-img">
                            </div>
                            <div class="prod-info">
                                <div class="prod-name">@item.Product?.Name</div>
                                <div class="prod-meta">
                                    Size: @(item.Size ?? "N/A") | Màu: @(item.Color ?? "N/A") <br>
                                    Số lượng: x @item.Quantity
                                </div>
                            </div>
                            <div class="prod-price d-flex flex-column align-items-end">
                                <div class="mb-2">@((item.UnitPrice * item.Quantity).ToString("N0")) đ</div>

                                @if (Model.Status == "Success" || Model.Status == "Completed")
                                {
                                    <button type="button" class="btn btn-sm btn-outline-success rounded-pill fw-bold"
                                            onclick="openRateModal('@item.ProductId', '@Model.OrderId', '@item.Product?.Name', '@item.Product?.ImageUrl')">
                                        <i class="bi bi-star-fill me-1"></i> Đánh giá
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>

                <div class="total-row">
                    <span class="total-text">Tổng cộng:</span>
                    <span class="total-money">@((Model.TotalAmount ?? 0).ToString("N0")) đ</span>
                </div>
            </div>

            <div class="col-lg-4 mb-4">
                <h5 class="section-title">Thông tin giao hàng</h5>
                <div class="info-box">
                    <div class="info-group">
                        <div class="info-label">Người nhận</div>
                        <div class="info-content">
                            <span class="info-icon"><i class="bi bi-person-fill"></i></span>
                            @receiverName
                        </div>
                    </div>

                    <div class="info-group">
                        <div class="info-label">Số điện thoại</div>
                        <div class="info-content">
                            <span class="info-icon"><i class="bi bi-telephone-fill"></i></span>
                            @receiverPhone
                        </div>
                    </div>

                    <div class="info-group">
                        <div class="info-label">Địa chỉ nhận hàng</div>
                        <div class="info-content">
                            <span class="info-icon"><i class="bi bi-geo-alt-fill"></i></span>
                            @shippingAddress
                        </div>
                    </div>

                    <div class="date-badge mt-3">
                        <i class="bi bi-calendar3 me-2"></i>
                        Ngày đặt hàng: <strong>@Model.OrderDate?.ToString("dd-MM-yyyy HH:mm")</strong>
                    </div>

                    @if (Model.Status == "Shipping")
                    {
                        var firstItem = Model.OrderDetails.FirstOrDefault();
                        var pName = firstItem?.Product?.Name ?? "Đơn hàng #" + Model.OrderId;
                        var pImg = firstItem?.Product?.ImageUrl ?? "/images/default.jpg";
                        var pMeta = $"Tổng {Model.OrderDetails.Sum(x => x.Quantity)} sản phẩm";
                        var pPrice = (Model.TotalAmount ?? 0).ToString("N0") + " đ";

                        <div class="mt-4">
                            <button type="button" class="btn btn-success w-100 fw-bold py-2 shadow-sm"
                                    onclick="showReceivedModal('@Model.OrderId', '@pName', '@pImg', '@pMeta', '@pPrice')">
                                <i class="bi bi-check-circle me-2"></i> ĐÃ NHẬN ĐƯỢC HÀNG
                            </button>
                        </div>
                    }

                    @if (Model.Status == "Pending" || Model.Status == "Packing")
                    {
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-danger w-100 fw-bold"
                                    data-bs-toggle="modal" data-bs-target="#cancelOrderModal"
                                    onclick="document.getElementById('cancelOrderId').value = '@Model.OrderId'">
                                Hủy Đơn Hàng
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-danger">Xác nhận hủy đơn hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="CancelOrder" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <input type="hidden" name="orderId" id="cancelOrderId" />
                    <p class="mb-3">Bạn có chắc chắn muốn hủy đơn hàng này không? Hành động này không thể hoàn tác.</p>
                    <textarea name="reason" class="form-control" rows="2" placeholder="Lý do hủy (không bắt buộc)..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
                    <button type="submit" class="btn btn-danger fw-bold">Đồng ý Hủy</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="receivedConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0 justify-content-center">
                <h4 class="fw-bold mt-3" style="font-family: serif; font-size: 24px;">Xác nhận đã nhận hàng?</h4>
            </div>

            <div class="modal-body p-4">
                <div class="d-flex align-items-center p-3 mb-4" style="background: #f8f9fa; border-radius: 15px; border: 1px solid #eee;">
                    <img id="conf-img" src="" class="rounded-3 me-3" style="width: 70px; height: 70px; object-fit: cover; border: 1px solid #ddd;">
                    <div class="flex-grow-1">
                        <div id="conf-name" class="fw-bold text-dark text-truncate" style="max-width: 250px;">Tên sản phẩm</div>
                        <div id="conf-meta" class="small text-muted">Size: ... | Màu: ...</div>
                        <div id="conf-price" class="fw-bold text-danger">0 đ</div>
                    </div>
                </div>

                <div class="alert alert-warning border-0 small mb-4" style="background-color: #fff8f0; color: #856404; border-radius: 12px; line-height: 1.6;">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Lưu ý:</strong> Sau khi xác nhận, số tiền sẽ được chuyển cho người bán. Bạn sẽ không thể yêu cầu trả hàng/hoàn tiền sau hành động này.
                </div>

                <form asp-action="ConfirmReceived" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="orderId" id="conf-orderId" />

                    <button type="submit" class="btn btn-dark w-100 py-3 fw-bold mb-2" style="border-radius: 12px; font-size: 16px;">
                        XÁC NHẬN NHẬN HÀNG
                    </button>
                    <button type="button" class="btn btn-link w-100 text-decoration-none text-muted fw-bold" data-bs-dismiss="modal">
                        Quay lại
                    </button>
                </form>

                <div class="text-center mt-3 pt-3 border-top" style="font-size: 10px; color: #ccc; letter-spacing: 1px;">
                    <i class="bi bi-shield-lock-fill me-1"></i> CURATED SECURITY GUARANTEED
                </div>
            </div>
        </div>
    </div>
</div>

<div id="rateModal" class="review-modal-overlay">
    <div class="review-modal-box">
        <form id="reviewForm">
            <input type="hidden" name="productId" id="rmProduct">
            <input type="hidden" name="orderId" id="rmOrder">
            <input type="hidden" name="rating" id="rmRating" value="0">

            <div class="rm-title">Rate your purchase</div>
            <div class="rm-subtitle">Đơn hàng #<span id="rmOrderIdDisplay"></span></div>

            <div class="rm-product-preview">
                <img id="rmImg" src="" class="rm-prod-img" alt="Product">
                <div>
                    <div style="font-weight:bold; color:#fff" id="rmName">Product Name</div>
                    <div style="font-size:12px; color:#10b981; letter-spacing: 0.5px;">VERIFIED PURCHASE</div>
                </div>
            </div>

            <p style="font-size:14px; margin-bottom: 8px;">How would you rate this item?</p>

            <div class="rm-stars">
                <i class="bi bi-star-fill rm-star" data-val="1"></i>
                <i class="bi bi-star-fill rm-star" data-val="2"></i>
                <i class="bi bi-star-fill rm-star" data-val="3"></i>
                <i class="bi bi-star-fill rm-star" data-val="4"></i>
                <i class="bi bi-star-fill rm-star" data-val="5"></i>
            </div>
            <div class="rm-rating-text" id="rmRatingText"></div>

            <p style="font-size:14px; margin-top:15px; margin-bottom: 5px;">Personal Feedback</p>
            <textarea name="comment" class="rm-textarea" rows="2" placeholder="Tell us about the condition, fit, and styling details..."></textarea>

            <p style="font-size:12px; color:#9ca3af; margin-bottom: 5px;">Upload Photos/Videos (Max 5 files)</p>
            <div class="rm-upload-area" onclick="document.getElementById('rmFile').click()">
                <div class="rm-plus-btn">+</div>
                <div style="color:#10b981; font-weight:bold; font-size:14px">Click to upload</div>
                <div style="font-size:11px; color:#6b7280">Show off your style</div>
                <input type="file" id="rmFile" name="mediaFiles" multiple accept="image/*,video/*" style="display:none">
                <div class="rm-preview-list" id="rmPreview"></div>
            </div>

            <button type="button" class="rm-cancel-btn" onclick="closeRateModal()">Cancel</button>
            <button type="button" class="rm-submit-btn" onclick="submitReview()">
                Submit Review <i class="bi bi-arrow-right"></i>
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <script src="~/js/order-actions.js" asp-append-version="true"></script>
    <script src="~/js/order-review.js" asp-append-version="true"></script>
}